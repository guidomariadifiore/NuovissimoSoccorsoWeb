<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SoccorsoWeb REST API - Client di Test</title>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                background-color: #f5f5f5;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                margin-bottom: 30px;
            }

            .section {
                background: white;
                padding: 20px;
                margin-bottom: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }

            .section h2 {
                color: #333;
                border-bottom: 2px solid #667eea;
                padding-bottom: 10px;
            }
.form-section {
                background: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin: 20px 0;
                border-left: 4px solid #007bff;
            }

            .operator-section {
                background: #e8f4f8;
                padding: 15px;
                border-radius: 8px;
                margin: 15px 0;
                border: 1px solid #17a2b8;
            }

            .operator-section h5 {
                color: #17a2b8;
                margin: 0 0 10px 0;
            }

            .info-box {
                background: #d1ecf1;
                padding: 15px;
                border-radius: 5px;
                margin: 15px 0;
                border-left: 4px solid #17a2b8;
            }

            .info-box h5 {
                color: #0c5460;
                margin: 0 0 10px 0;
            }

            .required {
                color: red;
            }

            .hidden {
                display: none;
            }

            .status-indicator {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 3px;
                font-size: 12px;
                font-weight: bold;
            }
            .form-group {
                margin-bottom: 15px;
            }

            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #555;
            }

            input[type="email"], input[type="password"], input[type="text"], textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-size: 14px;
                box-sizing: border-box;
            }

            button {
                background: #667eea;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                margin-right: 10px;
                margin-bottom: 10px;
            }

            button:hover {
                background: #5a6fd8;
            }

            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

            .response-area {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 5px;
                padding: 15px;
                margin-top: 15px;
                font-family: 'Courier New', monospace;
                white-space: pre-wrap;
                max-height: 300px;
                overflow-y: auto;
            }

            .success {
                color: #28a745;
                background-color: #d4edda;
                border-color: #c3e6cb;
            }

            .error {
                color: #dc3545;
                background-color: #f8d7da;
                border-color: #f5c6cb;
            }

            .info {
                color: #0c5460;
                background-color: #d1ecf1;
                border-color: #bee5eb;
            }

            .auth-status {
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 20px;
                text-align: center;
                font-weight: bold;
            }

            .logged-out {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .logged-in {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .two-column {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            @media (max-width: 768px) {
                .two-column {
                    grid-template-columns: 1fr;
                }
            }
            .button-row {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin: 15px 0;
            }

            .button-row button {
                flex: 1;
                min-width: 150px;
                padding: 12px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s ease;
            }

            /* Pulsante convalida verde */
            .button-row button[style*="background-color: #28a745"] {
                color: white;
            }

            .button-row button[style*="background-color: #28a745"]:hover {
                background-color: #218838 !important;
                transform: translateY(-2px);
            }

            /* Stili per risposte con warning */
            .response-area.warning {
                background-color: #fff3cd;
                border-color: #ffeaa7;
                color: #856404;
            }

            /* Miglioramento per i form a due colonne */
            .two-column {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin: 15px 0;
            }

            @media (max-width: 768px) {
                .two-column {
                    grid-template-columns: 1fr;
                }

                .button-row {
                    flex-direction: column;
                }

                /* Stili per i pulsanti operatori */
                .button-row button[style*="background-color: #28a745"] {
                    color: white;
                }

                .button-row button[style*="background-color: #28a745"]:hover {
                    background-color: #218838 !important;
                }

                .button-row button[style*="background-color: #17a2b8"] {
                    color: white;
                }

                .button-row button[style*="background-color: #17a2b8"]:hover {
                    background-color: #138496 !important;
                }

                .button-row button[style*="background-color: #6f42c1"] {
                    color: white;
                }

                .button-row button[style*="background-color: #6f42c1"]:hover {
                    background-color: #5a32a3 !important;
                }

                .button-row button[style*="background-color: #fd7e14"] {
                    color: white;
                }

                .button-row button[style*="background-color: #fd7e14"]:hover {
                    background-color: #e8681a !important;
                }

                /* Responsive per i pulsanti operatori */
                @media (max-width: 768px) {
                    .button-row {
                        grid-template-columns: 1fr 1fr;
                        gap: 10px;
                    }

                    .button-row button {
                        min-width: auto;
                        font-size: 12px;
                        padding: 8px 12px;
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üöë SoccorsoWeb REST API</h1>
                <p>Client di Test per le API REST</p>
            </div>

            <!-- Status di autenticazione -->
            <div id="authStatus" class="auth-status logged-out">
                ‚ùå Non autenticato
            </div>

            <!-- Sezione 1: Autenticazione -->
            <div class="section">
                <h2>üîê 1. Login/Logout (Operazione richiesta)</h2>

                <div class="two-column">
                    <div>
                        <h3>Login</h3>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" value="admin@soccorso.it" placeholder="Inserisci email">
                        </div>
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <input type="password" id="password" value="admin123" placeholder="Inserisci password">
                        </div>
                        <button onclick="doLogin()">Effettua Login</button>
                        <button onclick="verifyToken()" id="verifyBtn" disabled>Verifica Token</button>
                        <button onclick="doLogout()" id="logoutBtn" disabled>Logout</button>
                    </div>

                    <div>
                        <h3>Credenziali di Test</h3>
                        <p><strong>Admin:</strong> admin@soccorso.it / admin123</p>
                        <p><strong>Operatore:</strong> operatore@soccorso.it / op123</p>
                        <p><strong>Utente:</strong> utente@soccorso.it / user123</p>
                    </div>
                </div>

                <div class="response-area" id="authResponse">
                    Risultato dell'autenticazione apparir√† qui...
                </div>
            </div>

            <!-- Sezione 2: Inserimento Richiesta di Soccorso (CORRETTA) -->
            <div class="section">
                <h2>üÜò 2. Inserimento Richiesta di Soccorso (NO AUTH richiesta)</h2>

                <div class="form-group">
                    <label for="descrizione">Descrizione emergenza:</label>
                    <textarea id="descrizione" rows="3" placeholder="Descrivi l'emergenza...">Incendio in appartamento al secondo piano, presenza di feriti</textarea>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="indirizzo">Indirizzo:</label>
                        <input type="text" id="indirizzo" value="Via Roma 123, L'Aquila" placeholder="Indirizzo dell'emergenza" required>
                    </div>
                    <div class="form-group">
                        <label for="nome">Nome:</label>
                        <input type="text" id="nome" value="Incendio in appartamento" placeholder="Oggetto dell'emergenza" required>
                    </div>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="emailSegnalante">Email segnalante:</label>
                        <input type="email" id="emailSegnalante" value="mario.rossi@example.com" placeholder="La tua email" required>
                    </div>
                    <div class="form-group">
                        <label for="nomeSegnalante">Nome completo segnalante:</label>
                        <input type="text" id="nomeSegnalante" value="Mario Rossi" placeholder="Nome e cognome del segnalante" required>
                    </div>
                </div>

                <div class="two-column">
                    <div class="form-group">
                        <label for="coordinate">Coordinate GPS (opzionale):</label>
                        <input type="text" id="coordinate" placeholder="42.3598, 13.3986" title="Formato: latitudine, longitudine">
                    </div>
                    <div class="form-group">
                        <label for="foto">URL Foto (opzionale):</label>
                        <input type="url" id="foto" placeholder="https://esempio.com/foto-emergenza.jpg" title="Link a una foto dell'emergenza">
                    </div>
                </div>

                <div style="margin: 20px 0;">
                    <button onclick="fillTestData()" style="background: #17a2b8;
                            margin-right: 10px;">üìù Compila Dati Test</button>
                    <button onclick="clearForm()" style="background: #6c757d;">üßπ Pulisci Form</button>
                </div>

                <!-- QUESTO PULSANTE √à SEMPRE ATTIVO (NO AUTH) -->
                <button onclick="inserisciRichiesta()" id="richiestaBtn">üÜò Inserisci Richiesta</button>

                <div class="response-area" id="richiestaResponse">
                    Risultato dell'inserimento richiesta apparir√† qui...
                </div>
            </div>

            <!-- Sezione 3: Convalida Richiesta -->
            <div class="section">
                <h2>‚úÖ 3. Convalida Richiesta di Soccorso</h2>


                <div class="two-column">
                    <div>
                        <div class="form-group">
                            <label for="convalidaId">ID Richiesta:</label>
                            <input type="number" id="convalidaId" placeholder="Es: 123" min="1" 
                                   style="width: 100%;
                                   padding: 10px;
                                   border: 1px solid #ddd;
                                   border-radius: 5px;">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label for="convalidaToken">Token di Convalida:</label>
                            <input type="text" id="convalidaToken" placeholder="Es: abc123def456..." 
                                   style="width: 100%;
                                   padding: 10px;
                                   border: 1px solid #ddd;
                                   border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <div class="button-row">
                    <button onclick="doConvalida()" style="background-color: #28a745;">‚úÖ Convalida Richiesta</button>
                    <button onclick="fillConvalidaExample()">üìã Esempio Dati</button>
                    <button onclick="clearConvalidaForm()">üßπ Pulisci Form</button>
                </div>

                <div class="response-area" id="convalidaResponse">
                    Risultato della convalida apparir√† qui...
                </div>
            </div>


            <!-- Sezione 4: Lista Richieste di Soccorso -->
            <div class="section">
                <h2>üìã 4. Lista Richieste di Soccorso</h2>

                <div class="two-column">
                    <div>
                        <label for="filtroStato">Filtra per Stato:</label>
                        <select id="filtroStato">
                            <option value="">Tutte le richieste</option>
                            <option value="Inviata">Inviata</option>
                            <option value="Convalidata">Convalidata</option>
                            <option value="Attiva">Attiva</option>
                            <option value="Annullata">Annullata</option>
                            <option value="Chiusa">Chiusa</option>
                        </select>
                    </div>

                    <div>
                        <label for="pagina">Pagina:</label>
                        <input type="number" id="pagina" min="1" value="1" style="width: 80px;">
                    </div>
                </div>

                <div class="button-row">
                    <button id="listaBtn" onclick="getListaRichieste()" disabled>Carica Lista</button>
                    <button id="richiesteNonPositiveBtn" onclick="getRichiesteNonPositive()" disabled>Richieste Non Positive</button>
                    <button onclick="clearListaForm()">Pulisci Filtri</button>
                </div>

                <div class="response-area" id="listaResponse">
                    Pronto per il test di lista richieste...
                </div>
            </div>




            <!-- Sezione 5: Lista Operatori Attualmente Liberi (AGGIORNATA) -->
            <div class="section">
                <h2>üë®‚Äçüöí 5. Lista Operatori Attualmente Liberi</h2>

                <div class="button-row">
                    <button onclick="getOperatoriLiberiConDettagli()" id="operatoriBtn" disabled style="background-color: #28a745;">
                        üë®‚Äçüöí Operatori Liberi
                    </button>
                </div>

                <div class="form-group">
                    <label>
                        <em>üí° Informazioni sui test:</em>
                    </label>
                    <ul style="margin: 10px 0;
                        padding-left: 20px;
                        font-size: 14px;
                        color: #666;">
                        <li><strong>Operatori Liberi:</strong> Mostra operatori non impegnati in missioni attive</li>
                        <li><strong>Dettagli inclusi:</strong> Nome, email, codice fiscale, patenti possedute, abilit√† speciali</li>
                        <li><strong>Utilit√†:</strong> Ideale per assegnare operatori a nuove missioni</li>
                    </ul>
                </div>

                <div class="response-area" id="operatoriResponse">
                    Lista degli operatori liberi apparir√† qui...
                </div>
            </div>

           <!-- Sezione 7: Creazione Missione (AGGIORNATA) -->
    <!-- Sezione 7: Creazione Missione (AGGIORNATA - sempre visibile per admin) -->
    <div class="section">
        <h2>üéØ 7. Creazione Missione</h2>

        <!-- Form per creare missione (visibile solo per admin autenticati) -->
        <div id="sezionFormMissione" class="form-section hidden">
            <h3 style="color: #007bff; margin-bottom: 20px;">üìù Compila Dati Missione</h3>

            <!-- Informazioni richiesta -->
            <div class="form-group">
                <label for="richiestaIdMissione">ID Richiesta di Soccorso <span class="required">*</span>:</label>
                <input type="number" id="richiestaIdMissione" min="1" placeholder="ID della richiesta convalidata">
                <small style="color: #666;">Solo richieste in stato "Convalidata" possono essere utilizzate per creare missioni</small>
            </div>

            <!-- Dati missione -->
            <div class="two-column">
                <div class="form-group">
                    <label for="nomeMissione">Nome Missione <span class="required">*</span>:</label>
                    <input type="text" id="nomeMissione" maxlength="45" placeholder="Nome identificativo della missione">
                </div>
                <div class="form-group">
                    <label for="posizioneMissione">Posizione <span class="required">*</span>:</label>
                    <input type="text" id="posizioneMissione" maxlength="100" placeholder="Luogo dell'intervento">
                </div>
            </div>

            <div class="form-group">
                <label for="obiettivoMissione">Obiettivo <span class="required">*</span>:</label>
                <textarea id="obiettivoMissione" rows="3" placeholder="Descrizione dell'obiettivo della missione"></textarea>
            </div>

            <!-- Sezione Operatori -->
            <div class="operator-section">
                <h5>üë• Assegnazione Operatori</h5>
                
                <div class="form-group">
                    <label for="caposquadraMissione">Caposquadra <span class="required">*</span>:</label>
                    <input type="text" id="caposquadraMissione" placeholder="ID del caposquadra (es: 1,2)">
                    <small style="color: #666;">Inserire almeno un ID di operatore che far√† da caposquadra</small>
                </div>
                
                <div class="form-group">
                    <label for="operatoriStandardMissione">Operatori Standard:</label>
                    <input type="text" id="operatoriStandardMissione" placeholder="ID operatori separati da virgola (es: 3,4,5)">
                    <small style="color: #666;">Operatori che supporteranno il caposquadra (opzionale)</small>
                </div>
            </div>

            <!-- Sezione Mezzi -->
            <div class="form-group">
                <label for="mezziMissione">Mezzi (Targhe):</label>
                <input type="text" id="mezziMissione" placeholder="Targhe separate da virgola (es: AB123CD,EF456GH)">
                <small style="color: #666;">Inserire le targhe dei mezzi, non gli ID</small>
            </div>

            <div class="form-group">
                <label for="materialiMissione">Materiali (ID):</label>
                <input type="text" id="materialiMissione" placeholder="ID materiali separati da virgola (es: 1,2,3)">
                <small style="color: #666;">ID dei materiali necessari per la missione</small>
            </div>

            <!-- Info orario -->
            <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin: 15px 0;">
                <strong>üïê Orario di creazione:</strong>
                <span id="orarioCreazione">--</span>
            </div>

            <!-- Pulsanti azione (RIMOSSO il pulsante pulisci) -->
            <div class="button-row">
                <button onclick="creaMissione()" style="background-color: #28a745;">
                    üöÄ Crea Missione
                </button>
                <button onclick="nascondiFormMissione()" style="background-color: #6c757d;">
                    ‚ùå Chiudi Form
                </button>
            </div>

            <!-- Info validazione -->
            <div class="info-box">
                <h5>üí° Requisiti per la creazione:</h5>
                <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #0c5460;">
                    <li><strong>ID Richiesta:</strong> Deve essere una richiesta esistente in stato "CONVALIDATA"</li>
                    <li><strong>Caposquadra:</strong> Almeno un operatore deve essere assegnato come caposquadra</li>
                    <li><strong>Operatori:</strong> Devono essere disponibili (non impegnati in altre missioni)</li>
                    <li><strong>Mezzi:</strong> Inserire le targhe, non gli ID</li>
                    <li><strong>Stato richiesta:</strong> Dopo la creazione, la richiesta passer√† da "Convalidata" ad "Attiva"</li>
                </ul>
            </div>
        </div>

        <!-- Messaggio per non-admin -->
        <div id="messaggioNonAdmin" class="response-area" style="display: none; background-color: #fff3cd; border-color: #ffeaa7; color: #856404;">
            ‚ö†Ô∏è Solo gli amministratori possono creare missioni. Effettua il login come amministratore per accedere a questa funzionalit√†.
        </div>

        <!-- Area di risposta generale -->
        <div class="response-area" id="missioneResponse">
            Effettua il login come amministratore per creare missioni...
        </div>
    </div>
    <!-- Sezione 9: Annullamento Richiesta di Soccorso (NUOVO) -->
            <div class="section">
                <h2>‚ùå 9. Annullamento Richiesta di Soccorso (Solo Admin)</h2>

                <div class="form-group">
                    <label for="annullaRichiestaId">ID Richiesta da Annullare:</label>
                    <input type="number" id="annullaRichiestaId" min="1" placeholder="Inserisci l'ID della richiesta da annullare">
                    <small style="color: #666;">Solo richieste non chiuse possono essere annullate</small>
                </div>

                <div class="info-box">
                    <h5>‚ö†Ô∏è Condizioni per l'annullamento:</h5>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #0c5460;">
                        <li><strong>Solo amministratori</strong> possono annullare richieste</li>
                        <li><strong>Non si possono annullare</strong> richieste gi√† chiuse</li>
                        <li><strong>Non si possono annullare</strong> richieste con missioni attive</li>
                        <li><strong>Stati annullabili:</strong> Inviata, Convalidata, Attiva</li>
                    </ul>
                </div>

                <div class="button-row">
                    <button onclick="annullaRichiesta()" id="annullaBtn" disabled style="background-color: #dc3545;">
                        ‚ùå Annulla Richiesta
                    </button>
                    <button onclick="clearAnnullaForm()">üßπ Pulisci Form</button>
                    <button onclick="fillAnnullaExample()">üìã Esempio</button>
                </div>

                <div class="response-area" id="annullaResponse">
                    Effettua il login come amministratore per annullare richieste...
                </div>
            </div>
            <!-- Sezione Test Vari -->
            <div class="section">
                <h2>üß™ Test Vari</h2>

                <button onclick="testHealth()">Test Health Check</button>
                <button onclick="testCORS()">Test CORS</button>
                <button onclick="clearAllResponses()">Pulisci Tutte le Risposte</button>

                <div class="response-area" id="testResponse">
                    Risultati dei test vari...
                </div>
            </div>

            <script>
                // Configurazione API
                const API_BASE_URL = 'http://localhost:8080/nuovissimo-soccorso-web-1.0-SNAPSHOT/api';
                let authToken = null;
                let currentUser = null;

                // === FUNZIONI HELPER ===
                
                // Utility function per le chiamate API
                async function apiCall(endpoint, options = {}) {
                    const url = `${API_BASE_URL}${endpoint}`;

                    const defaultOptions = {
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    };

                    // Aggiungi token se disponibile
                    if (authToken) {
                        defaultOptions.headers['Authorization'] = `Bearer ${authToken}`;
                    }

                    const finalOptions = {
                        ...defaultOptions,
                        ...options,
                        headers: {
                            ...defaultOptions.headers,
                            ...options.headers
                        }
                    };

                    try {
                        const response = await fetch(url, finalOptions);
                        const data = await response.json();

                        return {
                            ok: response.ok,
                            status: response.status,
                            data: data,
                            headers: response.headers
                        };
                    } catch (error) {
                        return {
                            ok: false,
                            status: 0,
                            data: {error: 'NETWORK_ERROR', message: error.message},
                            headers: null
                        };
                    }
                }

                function showResponse(elementId, message, type = 'info') {
                    const element = document.getElementById(elementId);
                    element.textContent = message;
                    element.className = `response-area ${type}`;
                }

                // === FUNZIONI DI AUTENTICAZIONE ===
                
                async function doLogin() {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;

                    if (!email || !password) {
                        showResponse('authResponse', 'Inserisci email e password', 'error');
                        return;
                    }

                    showResponse('authResponse', 'Login in corso...', 'info');

                    try {
                        const result = await apiCall('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify({ email, password })
                        });

                        // DEBUG: Stampa tutta la risposta per vedere cosa arriva
                        console.log('=== DEBUG LOGIN RESPONSE ===');
                        console.log('result.ok:', result.ok);
                        console.log('result.status:', result.status);
                        console.log('result.data:', result.data);
                        console.log('============================');

                        if (result.ok) {
                            authToken = result.data.token;
                            
                            // DEBUG: Controlla come viene estratto il ruolo
                            console.log('Token estratto:', authToken);
                            console.log('result.data.role:', result.data.role);
                            console.log('result.data.user:', result.data.user);
                            
                            // Prova diversi modi di estrarre il ruolo
                            let userRole = null;
                            let isAdmin = false;
                            
                            if (result.data.role) {
                                userRole = result.data.role;
                            } else if (result.data.user && result.data.user.role) {
                                userRole = result.data.user.role;
                            }
                            
                            console.log('userRole estratto:', userRole);
                            
                            // Controlla se √® admin con diverse varianti
                            if (userRole) {
                                isAdmin = userRole.toLowerCase() === 'admin' || 
                                         userRole.toLowerCase() === 'amministratore' ||
                                         userRole.toUpperCase() === 'ADMIN';
                            }
                            
                            console.log('isAdmin calcolato:', isAdmin);
                            
                            // Salva i dati utente
                            currentUser = {
                                email: email,
                                role: userRole,
                                isAdmin: isAdmin
                            };
                            
                            updateAuthStatus(true, isAdmin);
                            
                            let message = `‚úÖ Login effettuato con successo!\n\n`;
                            message += `Email: ${email}\n`;
                            message += `Ruolo estratto: ${userRole || 'NON TROVATO'}\n`;
                            message += `√à admin: ${isAdmin ? 'S√å' : 'NO'}\n`;
                            message += `Token: ${authToken.substring(0, 30)}...\n`;
                            
                            showResponse('authResponse', message, 'success');
                            
                            // Se √® admin, mostra automaticamente il form missione
                            if (isAdmin) {
                                mostraFormMissioneAutomatic();
                            } else {
                                showResponse('missioneResponse', '‚ö†Ô∏è Utente non amministratore. Solo gli admin possono creare missioni.', 'warning');
                            }
                        } else {
                            showResponse('authResponse', `‚ùå Login fallito: ${result.data.error || result.data.message}`, 'error');
                        }
                    } catch (error) {
                        console.error('Errore durante login:', error);
                        showResponse('authResponse', `‚ùå Errore di rete: ${error.message}`, 'error');
                    }
                }

                function doLogout() {
                    authToken = null;
                    currentUser = null;
                    updateAuthStatus(false);
                    
                    // Nascondi il form missione
                    document.getElementById('sezionFormMissione').style.display = 'none';
                    document.getElementById('messaggioNonAdmin').style.display = 'none';
                    showResponse('missioneResponse', 'Effettua il login come amministratore per creare missioni...', 'info');
                    
                    showResponse('authResponse', 'üëã Logout effettuato', 'info');
                }

                async function verifyToken() {
                    if (!authToken) {
                        showResponse('authResponse', 'Nessun token da verificare', 'error');
                        return;
                    }

                    const result = await apiCall('/auth/verify');

                    if (result.ok && result.data.valid) {
                        showResponse('authResponse',
                                `‚úÖ Token valido!\nUtente: ${result.data.user.email}\nRuolo: ${result.data.user.role}`,
                                'success');
                    } else {
                        showResponse('authResponse',
                                `‚ùå Token non valido: ${result.data.message || 'Token scaduto o malformato'}`,
                                'error');
                        authToken = null;
                        currentUser = null;
                        updateAuthStatus(false);
                    }
                }

                function updateAuthStatus(isLoggedIn, isAdmin) {
                    // Se isAdmin non √® specificato, lo impostiamo a false
                    if (isAdmin === undefined) {
                        isAdmin = false;
                    }
                    
                    const statusElement = document.getElementById('authStatus');
                    const buttons = ['verifyBtn', 'logoutBtn', 'listaBtn', 'richiesteNonPositiveBtn', 'operatoriBtn', 'annullaBtn']; // AGGIUNTO annullaBtn

                    if (isLoggedIn) {
                        statusElement.textContent = `‚úÖ Autenticato come: ${currentUser ? currentUser.email : 'Utente'} (${currentUser ? currentUser.role : 'N/A'})`;
                        statusElement.className = 'auth-status logged-in';
                        buttons.forEach(id => {
                            const btn = document.getElementById(id);
                            if (btn) btn.disabled = false;
                        });
                        
                        // Gestisci visibilit√† form missione basata sul ruolo
                        if (isAdmin) {
                            document.getElementById('messaggioNonAdmin').style.display = 'none';
                        } else {
                            document.getElementById('sezionFormMissione').style.display = 'none';
                            document.getElementById('messaggioNonAdmin').style.display = 'block';
                            showResponse('missioneResponse', '', '');
                        }
                    } else {
                        statusElement.textContent = '‚ùå Non autenticato';
                        statusElement.className = 'auth-status logged-out';
                        buttons.forEach(id => {
                            const btn = document.getElementById(id);
                            if (btn) btn.disabled = true;
                        });
                        
                        // Nascondi tutto quando non autenticato
                        document.getElementById('sezionFormMissione').style.display = 'none';
                        document.getElementById('messaggioNonAdmin').style.display = 'none';
                    }
                }

                // === FUNZIONI MISSIONE ===
                
                function mostraFormMissioneAutomatic() {
                    document.getElementById('sezionFormMissione').style.display = 'block';
                    document.getElementById('messaggioNonAdmin').style.display = 'none';
                    updateOrarioCreazione();
                    showResponse('missioneResponse', '‚úÖ Accesso autorizzato! Compila i campi per creare una nuova missione.', 'success');
                }

                function nascondiFormMissione() {
                    document.getElementById('sezionFormMissione').style.display = 'none';
                    showResponse('missioneResponse', 'Form chiuso.', 'info');
                }

                function updateOrarioCreazione() {
                    const now = new Date();
                    const orarioFormattato = now.toLocaleString('it-IT', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    document.getElementById('orarioCreazione').textContent = orarioFormattato;
                }

                async function creaMissione() {
                    if (!authToken) {
                        showResponse('missioneResponse', 'Devi prima effettuare il login', 'error');
                        return;
                    }

                    // Raccogli dati dal form
                    const richiestaId = parseInt(document.getElementById('richiestaIdMissione').value);
                    const nome = document.getElementById('nomeMissione').value.trim();
                    const posizione = document.getElementById('posizioneMissione').value.trim();
                    const obiettivo = document.getElementById('obiettivoMissione').value.trim();
                    const caposquadra = document.getElementById('caposquadraMissione').value.trim();
                    const operatoriStandard = document.getElementById('operatoriStandardMissione').value.trim();
                    const mezzi = document.getElementById('mezziMissione').value.trim();
                    const materiali = document.getElementById('materialiMissione').value.trim();

                    // Validazioni client-side
                    if (!richiestaId || richiestaId <= 0) {
                        showResponse('missioneResponse', '‚ùå Inserisci un ID richiesta valido', 'error');
                        return;
                    }

                    if (!nome) {
                        showResponse('missioneResponse', '‚ùå Il nome della missione √® obbligatorio', 'error');
                        return;
                    }

                    if (!posizione) {
                        showResponse('missioneResponse', '‚ùå La posizione √® obbligatoria', 'error');
                        return;
                    }

                    if (!obiettivo) {
                        showResponse('missioneResponse', '‚ùå L\'obiettivo √® obbligatorio', 'error');
                        return;
                    }

                    if (!caposquadra) {
                        showResponse('missioneResponse', '‚ùå Almeno un caposquadra √® obbligatorio', 'error');
                        return;
                    }

                    // Combina caposquadra e operatori standard
                    let tuttiOperatori = caposquadra;
                    if (operatoriStandard) {
                        tuttiOperatori += ',' + operatoriStandard;
                    }

                    // Prepara i dati della richiesta
                    const missioneData = {
                        richiestaId: richiestaId,
                        nome: nome,
                        posizione: posizione,
                        obiettivo: obiettivo,
                        operatori: tuttiOperatori,
                        mezzi: mezzi || null,
                        materiali: materiali || null,
                        caposquadra: caposquadra,
                        operatoriStandard: operatoriStandard || null
                    };

                    showResponse('missioneResponse', 'Creazione missione in corso...', 'info');

                    try {
                        const result = await apiCall('/missioni', {
                            method: 'POST',
                            body: JSON.stringify(missioneData)
                        });

                        if (result.ok) {
                            const response = result.data;
                            let message = `‚úÖ ${response.message}\n\n`;
                            message += `üéØ Dettagli missione creata:\n`;
                            message += `‚Ä¢ Nome: ${response.missione.nome}\n`;
                            message += `‚Ä¢ Posizione: ${response.missione.posizione}\n`;
                            message += `‚Ä¢ Obiettivo: ${response.missione.obiettivo}\n`;
                            message += `‚Ä¢ ID Richiesta: ${response.missione.codiceRichiesta}\n`;
                            message += `‚Ä¢ Data/Ora Inizio: ${new Date(response.missione.dataOraInizio).toLocaleString('it-IT')}\n`;
                            
                            if (response.emailOperatori && response.emailOperatori.length > 0) {
                                message += `\nüìß Email notifiche inviate a:\n`;
                                response.emailOperatori.forEach(email => {
                                    message += `‚Ä¢ ${email}\n`;
                                });
                            }

                            showResponse('missioneResponse', message, 'success');
                            clearMissioneFormSilent();
                        } else {
                            let errorMessage = `‚ùå Errore nella creazione: ${result.data.error || result.data.message || 'Errore sconosciuto'}`;
                            
                            if (result.status === 400) {
                                errorMessage = `‚ùå Dati non validi: ${result.data.error || 'Controlla i campi inseriti'}`;
                            } else if (result.status === 401) {
                                errorMessage = '‚ùå Sessione scaduta. Effettua nuovamente il login.';
                            } else if (result.status === 403) {
                                errorMessage = '‚ùå Accesso negato. Solo gli amministratori possono creare missioni.';
                            }

                            showResponse('missioneResponse', errorMessage, 'error');
                        }
                    } catch (error) {
                        showResponse('missioneResponse', `‚ùå Errore di rete: ${error.message}`, 'error');
                    }
                }

                function clearMissioneFormSilent() {
                    document.getElementById('richiestaIdMissione').value = '';
                    document.getElementById('nomeMissione').value = '';
                    document.getElementById('posizioneMissione').value = '';
                    document.getElementById('obiettivoMissione').value = '';
                    document.getElementById('caposquadraMissione').value = '';
                    document.getElementById('operatoriStandardMissione').value = '';
                    document.getElementById('mezziMissione').value = '';
                    document.getElementById('materialiMissione').value = '';
                    updateOrarioCreazione();
                }

                // === FUNZIONI RICHIESTE ===
                
                async function inserisciRichiesta() {
                    const descrizione = document.getElementById('descrizione').value;
                    const indirizzo = document.getElementById('indirizzo').value;
                    const nome = document.getElementById('nome').value;
                    const emailSegnalante = document.getElementById('emailSegnalante').value;
                    const nomeSegnalante = document.getElementById('nomeSegnalante').value;
                    const coordinate = document.getElementById('coordinate').value;
                    const foto = document.getElementById('foto').value;

                    if (!descrizione || descrizione.trim().length < 10) {
                        showResponse('richiestaResponse', '‚ùå La descrizione deve essere di almeno 10 caratteri', 'error');
                        return;
                    }

                    if (!indirizzo || indirizzo.trim().length < 5) {
                        showResponse('richiestaResponse', '‚ùå L\'indirizzo √® obbligatorio e deve essere valido', 'error');
                        return;
                    }

                    if (!nome || nome.trim().length < 2) {
                        showResponse('richiestaResponse', '‚ùå Il nome √® obbligatorio', 'error');
                        return;
                    }

                    if (!emailSegnalante || !emailSegnalante.includes('@')) {
                        showResponse('richiestaResponse', '‚ùå L\'email del segnalante √® obbligatoria e deve essere valida', 'error');
                        return;
                    }

                    if (!nomeSegnalante || nomeSegnalante.trim().length < 2) {
                        showResponse('richiestaResponse', '‚ùå Il nome del segnalante √® obbligatorio', 'error');
                        return;
                    }

                    const richiestaData = {
                        descrizione: descrizione.trim(),
                        indirizzo: indirizzo.trim(),
                        nome: nome.trim(),
                        emailSegnalante: emailSegnalante.trim(),
                        nomeSegnalante: nomeSegnalante.trim(),
                        coordinate: coordinate.trim() || null,
                        foto: foto.trim() || null
                    };

                    try {
                        showResponse('richiestaResponse', 'üîÑ Invio richiesta di soccorso...', 'info');

                        const response = await fetch(`${API_BASE_URL}/richieste`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(richiestaData)
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            showResponse('richiestaResponse',
                                    `‚úÖ ${result.message}\n\n` +
                                    `üìã Codice Richiesta: ${result.richiesta.codice}\n` +
                                    `üìç Stato: ${result.richiesta.stato}\n` +
                                    `üë§ Nome: ${result.richiesta.nome}\n` +
                                    `üìß Email: ${result.richiesta.emailSegnalante}\n` +
                                    `üè† Indirizzo: ${result.richiesta.indirizzo}\n` +
                                    `üîó Codice Validazione: ${result.richiesta.stringaValidazione}\n` +
                                    `${result.richiesta.coordinate ? `üåç Coordinate: ${result.richiesta.coordinate}\n` : ''}` +
                                    `${result.richiesta.foto ? `üì∑ Foto: ${result.richiesta.foto}\n` : ''}`,
                                    'success');
                        } else {
                            showResponse('richiestaResponse',
                                    `‚ùå Errore: ${result.message || 'Errore sconosciuto'}`,
                                    'error');
                        }

                    } catch (error) {
                        showResponse('richiestaResponse',
                                `‚ùå Errore di rete: ${error.message}`,
                                'error');
                    }
                }

                function fillTestData() {
                    document.getElementById('descrizione').value = "Incendio in appartamento al secondo piano, presenza di feriti. Fumo denso dalle finestre. Necessario intervento immediato di VVF e ambulanza.";
                    document.getElementById('indirizzo').value = "Via Roma 123, L'Aquila (AQ)";
                    document.getElementById('nome').value = "Mario Rossi";
                    document.getElementById('emailSegnalante').value = "mario.rossi@email.com";
                    document.getElementById('nomeSegnalante').value = "Mario Rossi";
                    document.getElementById('coordinate').value = "42.3598, 13.3986";
                    document.getElementById('foto').value = "";
                }

                function clearForm() {
                    document.getElementById('descrizione').value = "";
                    document.getElementById('indirizzo').value = "";
                    document.getElementById('nome').value = "";
                    document.getElementById('emailSegnalante').value = "";
                    document.getElementById('nomeSegnalante').value = "";
                    document.getElementById('coordinate').value = "";
                    document.getElementById('foto').value = "";
                    showResponse('richiestaResponse', 'Form pulito. Pronto per nuovi dati...', 'info');
                }

                // === FUNZIONI CONVALIDA ===
                
                async function doConvalida() {
                    const id = document.getElementById('convalidaId').value;
                    const token = document.getElementById('convalidaToken').value;

                    if (!id || !token) {
                        showResponse('convalidaResponse', 'Inserisci sia ID che token di convalida', 'error');
                        return;
                    }

                    if (id <= 0) {
                        showResponse('convalidaResponse', 'ID richiesta deve essere maggiore di 0', 'error');
                        return;
                    }

                    if (token.trim().length < 10) {
                        showResponse('convalidaResponse', 'Token troppo corto. Verifica di aver inserito il token completo.', 'error');
                        return;
                    }

                    showResponse('convalidaResponse', 'Convalida in corso...', 'info');

                    try {
                        const url = `${API_BASE_URL}/richieste/${id}/convalida?token=${encodeURIComponent(token)}`;

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            const richiesta = data.richiesta;
                            const message = `‚úÖ ${data.message}\n\n` +
                                    `Dettagli richiesta convalidata:\n` +
                                    `‚Ä¢ ID: ${richiesta.codice}\n` +
                                    `‚Ä¢ Stato: ${richiesta.stato}\n` +
                                    `‚Ä¢ Indirizzo: ${richiesta.indirizzo}\n` +
                                    `‚Ä¢ Segnalante: ${richiesta.nomeSegnalante}\n` +
                                    `‚Ä¢ Email: ${richiesta.emailSegnalante}\n` +
                                    `‚Ä¢ Descrizione: ${richiesta.descrizione.substring(0, 100)}${richiesta.descrizione.length > 100 ? '...' : ''}`;

                            showResponse('convalidaResponse', message, 'success');
                        } else {
                            let errorMessage = data.message || 'Errore sconosciuto durante la convalida';

                            if (response.status === 400) {
                                if (data.message && data.message.includes('gi√†')) {
                                    errorMessage = `‚ö†Ô∏è ${data.message}`;
                                    showResponse('convalidaResponse', errorMessage, 'warning');
                                    return;
                                }
                            } else if (response.status === 404) {
                                errorMessage = '‚ùå Richiesta non trovata. Verifica l\'ID inserito.';
                            } else if (response.status === 500) {
                                errorMessage = '‚ùå Errore interno del server. Riprova pi√π tardi.';
                            }

                            showResponse('convalidaResponse', errorMessage, 'error');
                        }
                    } catch (error) {
                        showResponse('convalidaResponse', `‚ùå Errore di rete: ${error.message}`, 'error');
                    }
                }

                function fillConvalidaExample() {
                    document.getElementById('convalidaId').value = "1";
                    document.getElementById('convalidaToken').value = "exemplo-token-123456789abcdef";
                    showResponse('convalidaResponse',
                            'üìã Form riempito con dati di esempio.\n\n' +
                            '‚ö†Ô∏è IMPORTANTE: Questi sono dati di esempio!\n' +
                            '‚Ä¢ L\'ID e il token devono corrispondere a una richiesta reale\n' +
                            '‚Ä¢ Il token viene inviato via email al segnalante\n' +
                            '‚Ä¢ La richiesta deve essere in stato PENDING_VALIDATION',
                            'info');
                }

                function clearConvalidaForm() {
                    document.getElementById('convalidaId').value = "";
                    document.getElementById('convalidaToken').value = "";
                    showResponse('convalidaResponse', 'Form di convalida pulito. Pronto per nuovi dati...', 'info');
                }

                // === ALTRE FUNZIONI ===
                
                async function getListaRichieste() {
                    if (!authToken) {
                        showResponse('listaResponse', 'Devi prima effettuare il login per vedere le richieste', 'error');
                        return;
                    }

                    const stato = document.getElementById('filtroStato').value;
                    const pagina = parseInt(document.getElementById('pagina').value) || 1;

                    if (pagina < 1) {
                        showResponse('listaResponse', 'Il numero di pagina deve essere >= 1', 'error');
                        return;
                    }

                    showResponse('listaResponse', 'Caricamento lista richieste...', 'info');

                    try {
                        let url = '/richieste';
                        const params = new URLSearchParams();

                        if (stato && stato.trim() !== '') {
                            params.append('stato', stato);
                        }
                        params.append('page', pagina.toString());
                        params.append('size', '5');

                        if (params.toString()) {
                            url += '?' + params.toString();
                        }

                        const result = await apiCall(url);

                        if (result.ok) {
                            const response = result.data;

                            let message = `‚úÖ Lista richieste caricata con successo!\n\n`;
                            message += `üìä Statistiche:\n`;
                            message += `‚Ä¢ Totale richieste: ${response.totalElements}\n`;
                            message += `‚Ä¢ Pagine totali: ${response.totalPages}\n`;
                            message += `‚Ä¢ Pagina corrente: ${response.number + 1}/${response.totalPages}\n`;
                            message += `‚Ä¢ Richieste in questa pagina: ${response.content.length}\n`;

                            if (response.content.length > 0) {
                                message += `\nüîç Richieste in questa pagina:\n`;
                                response.content.forEach((richiesta, index) => {
                                    message += `\n${index + 1}. ID: ${richiesta.codice}\n`;
                                    message += `   ‚Ä¢ Stato: ${richiesta.stato}\n`;
                                    message += `   ‚Ä¢ Segnalante: ${richiesta.nomeSegnalante}\n`;
                                    message += `   ‚Ä¢ Indirizzo: ${richiesta.indirizzo}\n`;
                                });
                            } else {
                                message += `\nüì≠ Nessuna richiesta trovata con i filtri specificati.`;
                            }

                            showResponse('listaResponse', message, 'success');
                        } else {
                            let errorMessage = `‚ùå Errore nel caricamento: ${result.data.error || result.data.message || 'Errore sconosciuto'}`;
                            if (result.status === 401) {
                                errorMessage = '‚ùå Sessione scaduta. Effettua nuovamente il login.';
                            } else if (result.status === 403) {
                                errorMessage = '‚ùå Accesso negato. Solo gli amministratori possono vedere tutte le richieste.';
                            }
                            showResponse('listaResponse', errorMessage, 'error');
                        }
                    } catch (error) {
                        showResponse('listaResponse', `‚ùå Errore di rete: ${error.message}`, 'error');
                    }
                }

                async function getRichiesteNonPositive() {
                    if (!authToken) {
                        showResponse('listaResponse', 'Devi prima effettuare il login per vedere le richieste', 'error');
                        return;
                    }

                    const pagina = parseInt(document.getElementById('pagina').value) || 1;

                    showResponse('listaResponse', 'Caricamento richieste non positive...', 'info');

                    try {
                        const url = `/richieste/non-positive?page=${pagina}&size=10`;
                        const result = await apiCall(url);

                        if (result.ok) {
                            const response = result.data;
                            let message = `‚úÖ Richieste non positive caricate!\n\n`;
                            message += `üìä Totale richieste non positive: ${response.totalElements}\n`;

                            if (response.content.length > 0) {
                                message += `\nüîç Richieste con livello di successo < 5:\n`;
                                response.content.forEach((richiesta, index) => {
                                    message += `\n${index + 1}. ID: ${richiesta.codice}\n`;
                                    message += `   ‚Ä¢ Segnalante: ${richiesta.nomeSegnalante}\n`;
                                });
                            } else {
                                message += `\nüéâ Ottime notizie! Non ci sono richieste con esito non positivo.`;
                            }

                            showResponse('listaResponse', message, 'success');
                        } else {
                            showResponse('listaResponse', `‚ùå Errore: ${result.data.error || 'Errore sconosciuto'}`, 'error');
                        }
                    } catch (error) {
                        showResponse('listaResponse', `‚ùå Errore di rete: ${error.message}`, 'error');
                    }
                }

                function clearListaForm() {
                    document.getElementById('filtroStato').value = '';
                    document.getElementById('pagina').value = '1';
                    showResponse('listaResponse', 'Filtri resettati. Pronto per una nuova ricerca...', 'info');
                }

                async function getOperatoriLiberiConDettagli() {
                    if (!authToken) {
                        showResponse('operatoriResponse', 'Devi prima effettuare il login per vedere gli operatori', 'error');
                        return;
                    }

                    showResponse('operatoriResponse', 'Caricamento operatori liberi...', 'info');

                    try {
                        const result = await apiCall('/operatori/liberi');

                        if (result.ok) {
                            const operatori = result.data;
                            let message = `‚úÖ Operatori liberi caricati!\n\n`;
                            message += `üë• Trovati ${operatori.length} operatori attualmente disponibili:\n\n`;

                            if (operatori.length > 0) {
                                operatori.forEach((operatore, index) => {
                                    message += `${index + 1}. üÜî ID: ${operatore.id}\n`;
                                    message += `   üë§ Nome: ${operatore.nome} ${operatore.cognome}\n`;
                                    message += `   üìß Email: ${operatore.email || 'N/A'}\n`;
                                    message += `   üÜî Codice Fiscale: ${operatore.codiceFiscale || 'N/A'}\n`;

                                    if (operatore.patenti && operatore.patenti.length > 0) {
                                        const patentiFormatted = operatore.patenti.map(p => p.replace('_', ' ')).join(', ');
                                        message += `   üöó Patenti: ${patentiFormatted}\n`;
                                    } else {
                                        message += `   üöó Patenti: Nessuna registrata\n`;
                                    }

                                    if (operatore.abilita && operatore.abilita.length > 0) {
                                        const abilitaFormatted = operatore.abilita.map(a => a.replace(/_/g, ' ').replace(/-/g, ' ')).join(', ');
                                        message += `   üõ†Ô∏è Abilit√†: ${abilitaFormatted}\n`;
                                    } else {
                                        message += `   üõ†Ô∏è Abilit√†: Nessuna registrata\n`;
                                    }

                                    message += `   üü¢ Stato: Libero\n`;

                                    if (index < operatori.length - 1) {
                                        message += `\n${'-'.repeat(30)}\n\n`;
                                    }
                                });
                            } else {
                                message += `üì≠ Nessun operatore libero al momento.`;
                            }

                            showResponse('operatoriResponse', message, 'success');
                        } else {
                            let errorMessage = `‚ùå Errore nel caricamento: ${result.data.error || result.data.message || 'Errore sconosciuto'}`;
                            if (result.status === 401) {
                                errorMessage = '‚ùå Sessione scaduta. Effettua nuovamente il login.';
                            } else if (result.status === 403) {
                                errorMessage = '‚ùå Accesso negato. Solo gli amministratori possono vedere gli operatori.';
                            }
                            showResponse('operatoriResponse', errorMessage, 'error');
                        }
                    } catch (error) {
                        showResponse('operatoriResponse', `‚ùå Errore di rete: ${error.message}`, 'error');
                    }
                }

                // === FUNZIONI TEST ===
                
                async function testHealth() {
                    showResponse('testResponse', 'Testing basic connectivity...', 'info');

                    const result = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'OPTIONS'
                    });

                    if (result.ok) {
                        showResponse('testResponse', '‚úÖ API raggiungibile, CORS configurato correttamente', 'success');
                    } else {
                        showResponse('testResponse', `‚ùå Problema di connettivit√†: ${result.status}`, 'error');
                    }
                }

                async function testCORS() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/auth/login`, {
                            method: 'OPTIONS',
                            headers: {
                                'Origin': window.location.origin,
                                'Access-Control-Request-Method': 'POST',
                                'Access-Control-Request-Headers': 'Content-Type'
                            }
                        });

                        showResponse('testResponse',
                                `‚úÖ Test CORS completato\nStatus: ${response.status}\nHeaders CORS: ${response.headers.get('Access-Control-Allow-Origin')}`,
                                'success');
                    } catch (error) {
                        showResponse('testResponse', `‚ùå Errore CORS: ${error.message}`, 'error');
                    }
                }

                function clearAllResponses() {
                    const responseAreas = [
                        'authResponse',
                        'richiestaResponse',
                        'convalidaResponse',
                        'listaResponse',
                        'operatoriResponse',
                        'missioneResponse',
                        'annullaResponse', // AGGIUNTO
                        'testResponse'
                    ];

                    responseAreas.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = 'Sezione pulita...';
                            element.className = 'response-area';
                        }
                    });

                    showResponse('testResponse', 'üßπ Tutte le sezioni sono state pulite!', 'success');
                }
                // === INIZIALIZZAZIONE ===
                document.addEventListener('DOMContentLoaded', function () {
                    updateAuthStatus(false);
                    showResponse('authResponse', 'Pronto per il test di autenticazione...');
                    showResponse('richiestaResponse', 'Pronto per il test di inserimento richiesta...');
                    showResponse('convalidaResponse', 'Pronto per il test di convalida richiesta...');
                    showResponse('listaResponse', 'Pronto per il test di lista richieste...');
                    showResponse('operatoriResponse', 'Pronto per il test di lista operatori...');
                    showResponse('missioneResponse', 'Effettua il login come amministratore per creare missioni...');
                    showResponse('testResponse', 'Pronto per i test di connettivit√†...');
                });
                // === FUNZIONI ANNULLAMENTO RICHIESTA ===
                
                async function annullaRichiesta() {
                    if (!authToken) {
                        showResponse('annullaResponse', 'Devi prima effettuare il login come amministratore', 'error');
                        return;
                    }

                    const richiestaId = parseInt(document.getElementById('annullaRichiestaId').value);

                    // Validazione input
                    if (!richiestaId || richiestaId <= 0) {
                        showResponse('annullaResponse', '‚ùå Inserisci un ID richiesta valido', 'error');
                        return;
                    }

                    // Conferma dall'utente
                    const conferma = confirm(`‚ö†Ô∏è ATTENZIONE!\n\nSei sicuro di voler ANNULLARE la richiesta ${richiestaId}?\n\nQuesta azione:\n‚Ä¢ Cambier√† lo stato in "Annullata"\n‚Ä¢ NON pu√≤ essere annullata\n‚Ä¢ Render√† la richiesta non pi√π gestibile\n\nConfermi l'annullamento?`);
                    
                    if (!conferma) {
                        showResponse('annullaResponse', 'üö´ Annullamento richiesta cancellato dall\'utente', 'info');
                        return;
                    }

                    showResponse('annullaResponse', 'Annullamento richiesta in corso...', 'info');

                    try {
                        const result = await apiCall(`/richieste/${richiestaId}/annulla`, {
                            method: 'PUT'
                        });

                        if (result.ok) {
                            const response = result.data;
                            
                            let message = `‚úÖ ${response.message}\n\n`;
                            message += `üìã Dettagli operazione:\n`;
                            message += `‚Ä¢ ID Richiesta: ${response.richiesta.codice}\n`;
                            message += `‚Ä¢ Stato precedente: ${response.statoOriginale}\n`;
                            message += `‚Ä¢ Stato attuale: ${response.richiesta.stato}\n`;
                            message += `‚Ä¢ Segnalante: ${response.richiesta.nomeSegnalante}\n`;
                            message += `‚Ä¢ Email: ${response.richiesta.emailSegnalante}\n`;
                            message += `‚Ä¢ Indirizzo: ${response.richiesta.indirizzo}\n`;
                            message += `‚Ä¢ Annullata da Admin ID: ${response.adminId}\n`;
                            message += `‚Ä¢ Descrizione: ${response.richiesta.descrizione.substring(0, 100)}${response.richiesta.descrizione.length > 100 ? '...' : ''}\n`;
                            
                            showResponse('annullaResponse', message, 'success');
                            
                            // Pulisci il form dopo il successo
                            clearAnnullaForm();
                            
                        } else {
                            let errorMessage = `‚ùå Errore nell'annullamento: ${result.data.error || result.data.message || 'Errore sconosciuto'}`;
                            
                            // Gestione errori specifici
                            if (result.status === 400) {
                                if (result.data.error === 'ALREADY_CANCELLED') {
                                    errorMessage = '‚ö†Ô∏è La richiesta √® gi√† stata annullata in precedenza';
                                } else if (result.data.error === 'CANNOT_CANCEL_CLOSED') {
                                    errorMessage = '‚ùå Non √® possibile annullare una richiesta gi√† chiusa';
                                } else if (result.data.error === 'HAS_ACTIVE_MISSIONS') {
                                    errorMessage = '‚ùå La richiesta ha missioni attive. Chiudi prima le missioni associate.';
                                } else {
                                    errorMessage = `‚ùå Richiesta non valida: ${result.data.message || 'Controlla l\'ID inserito'}`;
                                }
                            } else if (result.status === 401) {
                                errorMessage = '‚ùå Sessione scaduta. Effettua nuovamente il login.';
                            } else if (result.status === 403) {
                                errorMessage = '‚ùå Accesso negato. Solo gli amministratori possono annullare richieste.';
                            } else if (result.status === 404) {
                                errorMessage = '‚ùå Richiesta non trovata. Verifica l\'ID inserito.';
                            }

                            showResponse('annullaResponse', errorMessage, 'error');
                        }
                    } catch (error) {
                        showResponse('annullaResponse', `‚ùå Errore di rete: ${error.message}`, 'error');
                    }
                }

                function clearAnnullaForm() {
                    document.getElementById('annullaRichiestaId').value = '';
                    showResponse('annullaResponse', 'Form pulito. Inserisci l\'ID della richiesta da annullare.', 'info');
                }

                function fillAnnullaExample() {
                    document.getElementById('annullaRichiestaId').value = '1';
                    showResponse('annullaResponse', 
                        'üìã Form riempito con dati di esempio.\n\n' +
                        '‚ö†Ô∏è IMPORTANTE: Questo √® solo un esempio!\n' +
                        '‚Ä¢ L\'ID deve corrispondere a una richiesta reale\n' +
                        '‚Ä¢ La richiesta deve essere in uno stato annullabile\n' +
                        '‚Ä¢ L\'annullamento √® irreversibile\n' +
                        '‚Ä¢ Solo gli amministratori possono eseguire questa operazione',
                        'info');
                }
            </script>
        </body>
    </html>